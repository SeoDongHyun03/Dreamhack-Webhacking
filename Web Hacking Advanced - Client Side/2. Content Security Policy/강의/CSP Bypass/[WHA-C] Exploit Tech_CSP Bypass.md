# CSP 우회  
## 신뢰하는 도메인에 업로드  
CSP를 이용하면 브라우저가 **특정 출처에서만 자원을 불러오게끔 제한**함  
그러나 만약 해당 출처가 **파일 업로드 및 다운로드 기능을 제공**한다면, 공격자는 **그 출처에 스크립트를 업로드**한 뒤 **다운로드 경로로 웹 페이지에 자원을 포함**시킬 수 있음.  
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'">
...
<h1>검색 결과: <script src="/download_file.php?id=177742"></script></h1>
```
위의 코드처럼 **허용한 출처**에 파일을 **업로드**하고 그 파일(악성 파일일 수도...)을 **다운로드** 할 수 있다.  

### JSONP API  
만약 **허용한 출처**에 **JSONP API**를 지원하면 **callback** 파라미터에 스크립트를 삽입해서 공격 가능!!  

예시로 ***.google.com** 의 출처만 허용할 때, 구글에서 **JSONP API를 지원하는 서버**를 찾아서 **callback**을 사용할 수 있다.  
```http
https://accounts.google.com/o/oauth2/revoke?callback=alert(1);
```
위처럼 callback의 파라미터로 스크립트를 넣을 수 있다.  

그래서 이를 막기 위해 callback 파라미터에 **식별자를 제외한 문자를 거부**해서 방어할 수 있다.  
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'https://*.google.com/'">
...
<script src="https://accounts.google.com/o/oauth2/revoke?callback=alert(1);"></script>
<!-- JSONP API 결과:
// API callback
alert(1);({
  "error": {
    "code": 400,
    "message": "Invalid JSONP callback name: 'alert(1)'; only alphabet, number, '_', '$', '.', '[' and ']' are allowed.",
    "status": "INVALID_ARGUMENT"
  }
}
);
-->
```
위처럼 JSONP API의 문자 검사를 할 수 있다.  
#### JSONP란?  
**JSONP(JSON with Padding)** 은 웹 애플리케이션에서 **서로 다른 도메인**(Cross-Origin) 간에 **데이터를 주고받을 때** 사용되는 기술  

## nonce 예측 가능  
CSP의 **nonce**를 이용하면 **공격자가 예측할 수 없는 nonce 값**이 태그 **속성에 존재할 것을 요구**함으로써 **XSS 공격을 방어**할 수 있습니다.  
-> 알기 힘든 nonce 값이 태그에 있어야 스크립트를 허용한다.  
nonce를 사용할 때 주의해야할 사항이 몇가지 있다.  
1. **HTTP 헤더** 또는 **meta** 태그가 **캐싱**되지 않는지 주의해야 합니다. 
2. **PHP나 CGI 계열 스크립팅**을 사용할 때에는 스크립트들이 /index.php/style.css처럼 **뒤에 추가적인 경로를 붙여 접근**될 수 있기 때문입니다.  

만약 **확장자**를 기반으로 캐시 여부를 판단하면, **css** 파일은 보통 정적 파일이므로 **캐시에 저장할 수 있음**.  
-> 이 경우는 **캐시가 만료될 때까지** **같은 nonce**를 가지기 때문에 이를 통해 nonce 값을 얻을 수 있다.  

또한 nonce 값은 안전한 의사 난수 생성기(CSPRNG)를 사용하는 것이 좋음  

```
location ~ \.php {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/run/php/php7.2-fpm.sock;
}
```
위는 **Nginx와 PHP FastCGI SAPI(php-fpm)** 를 사용하였을 때의 예시이다.  

```html
<script nonce="{고정된 nonce 값}">alert(1);</script>
```

```# regex to split $uri to $fastcgi_script_name and $fastcgi_path
fastcgi_split_path_info ^(.+\.php)(/.+)$;

# Check that the PHP script exists before passing it
try_files $fastcgi_script_name =404;

# Bypass the fact that try_files resets $fastcgi_path_info
# see: http://trac.nginx.org/nginx/ticket/321
set $path_info $fastcgi_path_info;
fastcgi_param PATH_INFO $path_info;

fastcgi_index index.php;
include fastcgi.conf;
```
**fastcgi-php.conf**의 내용 일부이다.  
위의 설정에서 **/dom_xss_vulnerable.php/style.css** 의 주소로 접근하면 **dom_xss_vulnerable.php 파일이 실행**되어 nonce 가 **meta http-equiv="Content-Security-Policy" content="... nonce ..."** 태그로 출력된다.  
-> 이를 통해 nonce 값을 알 수 있음  

```
location ~ \.php$ {
    try_files $uri =404;
    fastcgi_index index.php;
    include fastcgi.conf;
    fastcgi_pass unix:/run/php/php7.2-fpm.sock;
}
```
위는 php 중복 방지 예시이다.  
**PATH_INFO** 사용하지 않으면, **URL의 끝 부분이 .php일때만 FastCGI로** 넘어가게 수정해야함.  
그리고 a/b.php/c/d.php와 같이 **.php가 중복 사용**될 때를 대비하여 fastcgi-php.conf 스니펫을 사용하지 않고 위처럼 php 중복을 방지해야 한다.  

## base-url 미지정  
하이퍼링크에서 **주소 없이 경로를 지정**하면 **현재 문서를 기준**으로 주소를 해석합니다.  
**base** 태그로 경로가 해석되는 기준과 **a, form** 등의 **target** 기본 값을 지정함  

만약 
```html
<base href="https://malice.test/xss-proxy/">
```
와 같은 markup을 삽입하면, 의도한 위치가 아닌 URL로 이동할 수 있다.  

```http
Content-Security-Policy: base-uri 'none'
```
그래서 위처럼 **base** 태그의 **href** 를 사용하지 않는다면 다음과 같이 **base-uri**를 거부해서 방어할 수 있다.  

```html
<base href="https://malice.test">
<script src="/jquery.js" nonce=NONCE> 
<!-- jquery.js는 base 태그에 의해 https://malice.test/jquery.js를 가리킵니다. -->
```
**base-uri CSP 구문이 없다**면 위처럼 **base 태그**를 이용하여 임의 자원을 로드할 수 있다.  
이와 같은 공격을 **Nonce Retargeting** 라고 한다.  

# 퀴즈  
1. script nonce 와 관련하여 옳지 못한 설명은 무엇인가?  
**답** : 웹사이트에 미리 접속하여 nonce를 복사해와서 사용하면 CSP를 우회할 수 있다.  
2. 지시문이 없을 경우 'default-src'를 참조하지 않는 지시문은 무엇인가?  
**답** : base-uri  
